```mermaid
graph TD
    A[fa:fa-user Tom] -->|Get money| B(Go shopping)
    B --> C{Select}
    C -->|One| D[Laptop]
    C -->|Two| E[iPhone]
    C -->|Three| F[fa:fa-car Car]
  import json
from xml.sax.saxutils import escape
from IPython.display import display, HTML

def json_to_uppaal_loop_cycle(json_data):
    component_name = json_data.get("component", "Component")
    states = json_data.get("states", [])
    transitions = json_data.get("transitions", [])

    xml_parts = []

    # NTA header
    xml_parts.append('<?xml version="1.0" encoding="utf-8"?>')
    xml_parts.append('<!DOCTYPE nta PUBLIC "-//Uppaal Team//DTD Flat System 1.6//EN" '
                     '"http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd">')
    xml_parts.append('<nta>')

    # 收集 channel
    channels = set()
    for t in transitions:
        trigger = t.get("trigger")
        if trigger:
            chan_name = f"widget{trigger['widget_id']}_evt{trigger['event_id']}"
            channels.add(chan_name)

    # 全局 declarations
    xml_parts.append('<declaration>// Global declarations')
    if channels:
        xml_parts.append("chan " + ", ".join(sorted(channels)) + ";")
    xml_parts.append("int task_executed = 0;  // 标记 execute_task 是否被执行")
    xml_parts.append('</declaration>')

    # ===========================
    # Controller template
    # ===========================
    xml_parts.append('<template>')
    xml_parts.append(f'  <name>{escape(component_name)}</name>')

    # Locations
    for idx, state in enumerate(states):
        x = 100 + (idx % 5) * 150
        y = 100 + (idx // 5) * 150
        xml_parts.append(f'  <location id="id{idx}" x="{x}" y="{y}">')
        xml_parts.append(f'    <name>{escape(state)}</name>')
        xml_parts.append('  </location>')

    xml_parts.append('  <init ref="id0"/>')

    # Transitions from JSON
    for t in transitions:
        from_idx = states.index(t["from"])
        to_idx = states.index(t["to"])
        trigger = t.get("trigger", {})
        chan_name = f"widget{trigger['widget_id']}_evt{trigger['event_id']}" if trigger else ""
        action_comment = t.get("action", "")
        assignment = f'task_executed = 1  // {escape(action_comment)}'

        xml_parts.append('  <transition>')
        xml_parts.append(f'    <source ref="id{from_idx}"/>')
        xml_parts.append(f'    <target ref="id{to_idx}"/>')
        if chan_name:
            xml_parts.append(f'    <label kind="synchronisation">{escape(chan_name)}?</label>')
        xml_parts.append(f'    <label kind="assignment">{assignment}</label>')
        xml_parts.append('  </transition>')

    # 新增循环 transition RUNNING -> IDLE
    if "RUNNING" in states and "IDLE" in states:
        running_idx = states.index("RUNNING")
        idle_idx = states.index("IDLE")
        xml_parts.append('  <transition>')
        xml_parts.append(f'    <source ref="id{running_idx}"/>')
        xml_parts.append(f'    <target ref="id{idle_idx}"/>')
        xml_parts.append('    <label kind="assignment">task_executed = 0</label>')
        xml_parts.append('  </transition>')

    xml_parts.append('</template>')

    # ===========================
    # Widget templates (循环发射)
    # ===========================
    widget_instances = {}
    for t in transitions:
        trigger = t.get("trigger")
        if trigger:
            chan_name = f"widget{trigger['widget_id']}_evt{trigger['event_id']}"
            widget_name = f"Widget{trigger['widget_id']}_Emitter_{trigger['event_id']}"
            if widget_name not in widget_instances:
                widget_instances[widget_name] = chan_name
                xml_parts.append('<template>')
                xml_parts.append(f'  <name>{widget_name}</name>')
                xml_parts.append('  <location id="l0" x="100" y="100">')
                xml_parts.append('    <name>l0</name>')
                xml_parts.append('  </location>')
                xml_parts.append('  <init ref="l0"/>')
                # 循环发射 channel
                xml_parts.append('  <transition>')
                xml_parts.append('    <source ref="l0"/>')
                xml_parts.append('    <target ref="l0"/>')
                xml_parts.append(f'    <label kind="synchronisation">{chan_name}!</label>')
                xml_parts.append('  </transition>')
                xml_parts.append('</template>')

    # ===========================
    # System declaration
    # ===========================
    xml_parts.append('<system>')
    xml_parts.append(f'{component_name}_inst = {component_name}();')
    for widget_inst in widget_instances.keys():
        template_name = "_".join(widget_inst.split("_")[:-1])
        xml_parts.append(f'{widget_inst} = {template_name}();')
    all_instances = [component_name + "_inst"] + list(widget_instances.keys())
    xml_parts.append('system ' + ", ".join(all_instances) + ';')
    xml_parts.append('</system>')

    xml_parts.append('</nta>')

    return "\n".join(xml_parts)


# ========================
# 读取 JSON 文件
# ========================
json_file_path = "behavior_model.json"
with open(json_file_path, "r", encoding="utf-8") as f:
    behavior_json = json.load(f)

# 生成循环状态机 XML
uppaal_xml = json_to_uppaal_loop_cycle(behavior_json)

# 保存文件
xml_file_path = "state_machine_loop_cycle.xml"
with open(xml_file_path, "w", encoding="utf-8") as f:
    f.write(uppaal_xml)

# 显示 XML
display(HTML(f"<pre>{escape(uppaal_xml)}</pre>"))
print(f"UPPAAL XML 已生成: {xml_file_path}")

```